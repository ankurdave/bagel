#!/bin/bash

source common-options.sh

LOGDIR=run-pregel-wiki-$DATE
INSTANCETYPE=m1.large
MEMORY=6500m
NUMSLAVES=12

source init-cluster.sh

read -p "Attach the volume to the master as /dev/sdf."

ssh -i $KEYPAIRFILE root@$MASTER \
    "source ~/.profile; \
     cd pregel-spark; \
     mkdir ~/wex; \
     mount /dev/sdf ~/wex; \
     ../hadoop-0.20.2/bin/hadoop fs -rm /wex.dat; \
     ../hadoop-0.20.2/bin/hadoop fs -put ~/wex/rawd/freebase-wex-2009-01-12-articles.tsv /wex.dat"

ssh -i $KEYPAIRFILE root@$MASTER \
    "source ~/.profile; \
     source /root/spark/conf/spark-env.sh; \
     cd pregel-spark; \
     ./run WikipediaPageRank $INPUTFILE 0.0001 $MESOSMASTER" \
	2>&1 | tee $LOGDIR/$manip-$trial.log
  done
done

read -p "Ending..."
echo y | mesos-ec2 --key-pair=$KEYPAIR --identity-file=$KEYPAIRFILE destroy $CLUSTERNAME
